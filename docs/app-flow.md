# App Flow

ðŸš€ **Version:** 0.7 (Updated with PrimaveraVan Festival integration)  
ðŸ“… **Date:** 2025-05-09
ðŸ‘¨â€ðŸ’» **Authors:** Ilia

---


### 2.11 PrimaveraVan Festival Subproject

ðŸŽª **PrimaveraVan Festival** - Ñ†Ðµ ÑÐ¿ÐµÑ†Ñ–Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¸Ð½Ð³Ð¾Ð²Ð¸Ð¹ Ð¼Ñ–ÐºÑ€Ð¾ÑÐ°Ð¹Ñ‚ Ð´Ð»Ñ Ñ„ÐµÑÑ‚Ð¸Ð²Ð°Ð»ÑŽ:

- ðŸŒ **Ð‘Ð°Ð³Ð°Ñ‚Ð¾Ð¼Ð¾Ð²Ð½Ð¸Ð¹ Ñ–Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ** - Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÑƒÑ” Ð°Ð½Ð³Ð»Ñ–Ð¹ÑÑŒÐºÑƒ, Ñ–ÑÐ¿Ð°Ð½ÑÑŒÐºÑƒ Ñ‚Ð° ÐºÐ°Ñ‚Ð°Ð»Ð°Ð½ÑÑŒÐºÑƒ Ð¼Ð¾Ð²Ð¸
- ðŸŽŸï¸ **ÐŸÑ€Ð¾Ð¼Ð¾-Ð°ÐºÑ†Ñ–Ñ—** - Ð¿Ñ–Ð´Ð¿Ð¸ÑÐºÐ° Ð½Ð° Instagram Ð´Ð»Ñ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ Ñ„ÐµÑÑ‚Ð¸Ð²Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÑ‚Ð°ÐºÐ°Ð½Ñƒ Ñ‚Ð° ÐºÐ¾Ð½ÐºÑƒÑ€Ñ Ð¼Ð°Ð»ÑŽÐ½ÐºÑ–Ð²
- ðŸ“± **Ð¤Ð¾Ñ€Ð¼Ð° Ð´Ð»Ñ Ð·Ð±Ð¾Ñ€Ñƒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ–Ð²** - Ñ–Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ñ–Ñ Ð· Supabase Ð´Ð»Ñ Ð·Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ñ–Ð¹Ð½Ð¸Ñ… ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ñ–Ð²
- ðŸ“Š **ÐŸÐ¾Ñ‚Ñ–Ðº Ð´Ð°Ð½Ð¸Ñ…:**
  1. ÐšÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð·Ð°Ð¿Ð¾Ð²Ð½ÑŽÑ” Ñ„Ð¾Ñ€Ð¼Ñƒ Ð· ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ð¸Ð¼Ð¸ Ð´Ð°Ð½Ð¸Ð¼Ð¸
  2. Ð”Ð°Ð½Ñ– Ð·Ð±ÐµÑ€Ñ–Ð³Ð°ÑŽÑ‚ÑŒÑÑ Ð² Supabase Ð· Ð¼Ð°Ñ€ÐºÐµÑ€Ð¾Ð¼ `source: 'primaveravan'`
  3. ÐšÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð¾Ñ‚Ñ€Ð¸Ð¼ÑƒÑ” Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾Ñ— Ñ€ÐµÑ”ÑÑ‚Ñ€Ð°Ñ†Ñ–Ñ—
  4. ÐÐ´Ð¼Ñ–Ð½Ñ–ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ Ð¼Ð¾Ð¶Ðµ Ð¿ÐµÑ€ÐµÐ³Ð»ÑÐ´Ð°Ñ‚Ð¸ Ð·Ñ–Ð±Ñ€Ð°Ð½Ñ– ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¸ Ñ‡ÐµÑ€ÐµÐ· MCP

#### 2.11.1 Ð¢ÐµÑ…Ð½Ñ–Ñ‡Ð½Ñ– Ð¾ÑÐ¾Ð±Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ– PrimaveraVan

- ðŸŒ **ÐŸÑ€Ð¾ÑÑ‚Ð° HTML/CSS/JS Ñ€ÐµÐ°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ** - ÑÑ‚Ð°Ñ‚Ð¸Ñ‡Ð½Ð¸Ð¹ ÑÐ°Ð¹Ñ‚ Ð· Ð¼Ñ–Ð½Ñ–Ð¼Ð°Ð»ÑŒÐ½Ð¸Ð¼Ð¸ Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸
- ðŸ”„ **Ð†Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ñ–Ñ Ð· Supabase** - Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ð½Ð½Ñ Supabase Ð´Ð»Ñ Ð·Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ Ð´Ð°Ð½Ð¸Ñ… Ñ„Ð¾Ñ€Ð¼
- ðŸŒ **Ð‘Ð°Ð³Ð°Ñ‚Ð¾Ð¼Ð¾Ð²Ð½Ñ–ÑÑ‚ÑŒ** - Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ð½Ð½Ñ JSON-Ñ„Ð°Ð¹Ð»Ñƒ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐºÐ»Ð°Ð´Ñ–Ð² Ñ‚Ð° JavaScript Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼Ð¸ÐºÐ°Ð½Ð½Ñ Ð¼Ð¾Ð²
- ðŸ“± **ÐÐ´Ð°Ð¿Ñ‚Ð¸Ð²Ð½Ð¸Ð¹ Ð´Ð¸Ð·Ð°Ð¹Ð½** - Ð¾Ð¿Ñ‚Ð¸Ð¼Ñ–Ð·Ð¾Ð²Ð°Ð½Ð¾ Ð´Ð»Ñ Ð¼Ð¾Ð±Ñ–Ð»ÑŒÐ½Ð¸Ñ… Ñ‚Ð° Ð´ÐµÑÐºÑ‚Ð¾Ð¿Ð½Ð¸Ñ… Ð¿Ñ€Ð¸ÑÑ‚Ñ€Ð¾Ñ—Ð²
- ðŸ“Š **Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ— Ñ„Ð¾Ñ€Ð¼Ð¸:**
  - Ð’Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ Ð¿Ð¾Ð»Ñ–Ð²
  - Ð—Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ Ð´Ð°Ð½Ð¸Ñ… Ð² Supabase Ñ‡ÐµÑ€ÐµÐ· API
  - Ð’Ñ–Ð´Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾ ÑƒÑÐ¿Ñ–Ñ… Ð¿Ñ–ÑÐ»Ñ Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²ÐºÐ¸

#### 2.11.2 API Endpoint Ð´Ð»Ñ PrimaveraVan

ðŸ”¹ **Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ:** `window.PrimaveravanAPI.savePrimaveraVanLead`  
ðŸ”¹ **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¸:**
  - `name` - Ð†Ð¼'Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°
  - `email` - Email ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°
  - `instagram` - Instagram Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŒ (Ð¾Ð¿Ñ†Ñ–Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
  - `privacy_accepted` - Ð§Ð¸ Ð¿Ñ€Ð¸Ð¹Ð½ÑÑ‚Ð¾ Ð¿Ð¾Ð»Ñ–Ñ‚Ð¸ÐºÑƒ ÐºÐ¾Ð½Ñ„Ñ–Ð´ÐµÐ½Ñ†Ñ–Ð¹Ð½Ð¾ÑÑ‚Ñ–
  - `source` - Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÑŽÑ”Ñ‚ÑŒÑÑ ÑÐº 'primaveravan'
  - `created_at` - Ð”Ð°Ñ‚Ð° ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð·Ð°Ð¿Ð¸ÑÑƒ
  
ðŸ”¹ **Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ:** 
```json
{
  "success": true
}
```

#### 2.11.3 Ð”Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾Ñ‚Ð¾ÐºÑƒ Ð´Ð°Ð½Ð¸Ñ… PrimaveraVan

```mermaid
sequenceDiagram
    participant Visitor as Ð’Ñ–Ð´Ð²Ñ–Ð´ÑƒÐ²Ð°Ñ‡ Ñ„ÐµÑÑ‚Ð¸Ð²Ð°Ð»ÑŽ
    participant Website as PrimaveraVan Website
    participant Supabase as Supabase DB
    participant Admin as MrVan Admin
    
    Visitor->>Website: Ð’Ñ–Ð´Ð²Ñ–Ð´ÑƒÑ” ÑÐ°Ð¹Ñ‚ Ñ„ÐµÑÑ‚Ð¸Ð²Ð°Ð»ÑŽ
    Website->>Visitor: ÐŸÐ¾ÐºÐ°Ð·ÑƒÑ” Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ Ñ‚Ð° Ð¿Ñ€Ð¾Ð¼Ð¾-Ð°ÐºÑ†Ñ–Ñ—
    
    alt Instagram Cup Promotion
        Visitor->>Website: ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð·Ð° Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½ÑÐ¼ Ð½Ð° Instagram
        Visitor->>Website: Ð’Ñ–Ð´Ð²Ñ–Ð´ÑƒÑ” ÑÑ‚ÐµÐ½Ð´ Ð½Ð° Ñ„ÐµÑÑ‚Ð¸Ð²Ð°Ð»Ñ–
    else Drawing Contest
        Visitor->>Website: Ð—Ð°Ð¿Ð¾Ð²Ð½ÑŽÑ” Ñ„Ð¾Ñ€Ð¼Ñƒ Ð´Ð»Ñ ÐºÐ¾Ð½ÐºÑƒÑ€ÑÑƒ
        Website->>Supabase: Ð—Ð±ÐµÑ€Ñ–Ð³Ð°Ñ” Ð´Ð°Ð½Ñ– ÑƒÑ‡Ð°ÑÐ½Ð¸ÐºÐ°
    end
    
    Visitor->>Website: Ð—Ð°Ð¿Ð¾Ð²Ð½ÑŽÑ” ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñƒ Ñ„Ð¾Ñ€Ð¼Ñƒ
    Website->>Supabase: savePrimaveraVanLead()
    Supabase-->>Website: ÐŸÐ¾Ð²ÐµÑ€Ñ‚Ð°Ñ” ÑÑ‚Ð°Ñ‚ÑƒÑ ÑƒÑÐ¿Ñ–Ñ…Ñƒ
    Website->>Visitor: ÐŸÐ¾ÐºÐ°Ð·ÑƒÑ” Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾ ÑƒÑÐ¿Ñ–Ñ…
    
    Admin->>Supabase: ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ” Ð´Ð°Ð½Ñ– Ñ‡ÐµÑ€ÐµÐ· MCP
    Supabase-->>Admin: ÐŸÐ¾Ð²ÐµÑ€Ñ‚Ð°Ñ” ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¸ Ð· source='primaveravan'
    Admin->>Admin: ÐžÐ±Ñ€Ð¾Ð±Ð»ÑÑ” Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ñ–Ð¹Ð½Ð¸Ñ… ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ñ–Ð²
```

---

## 3. API Endpoints Ð´Ð»Ñ DocuSign

### 3.1 Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð° Ð´Ð»Ñ ÐŸÑ–Ð´Ð¿Ð¸ÑÐ°Ð½Ð½Ñ

ðŸ”¹ **Endpoint:** `/api/docusign/create-envelope`  
ðŸ”¹ **ÐœÐµÑ‚Ð¾Ð´:** POST  
ðŸ”¹ **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¸ Ð·Ð°Ð¿Ð¸Ñ‚Ñƒ:**
  - `documentId` - ID Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°
  - `signerEmail` - Email Ð¿Ñ–Ð´Ð¿Ð¸ÑÐ°Ð½Ñ‚Ð°
  - `signerName` - Ð†Ð¼'Ñ Ð¿Ñ–Ð´Ð¿Ð¸ÑÐ°Ð½Ñ‚Ð°
  - `documentPath` - Ð¨Ð»ÑÑ… Ð´Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð° Ð´Ð»Ñ Ð¿Ñ–Ð´Ð¿Ð¸ÑÐ°Ð½Ð½Ñ
  
ðŸ”¹ **Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ:** 
```json
{
  "success": true,
  "envelopeId": "abc123-xyz789"
}
```

### 3.2 ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ URL Ð´Ð»Ñ Ð’Ð±ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¾Ð³Ð¾ ÐŸÑ–Ð´Ð¿Ð¸ÑÐ°Ð½Ð½Ñ

ðŸ”¹ **Endpoint:** `/api/docusign/embedded-signing`  
ðŸ”¹ **ÐœÐµÑ‚Ð¾Ð´:** POST  
ðŸ”¹ **ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¸ Ð·Ð°Ð¿Ð¸Ñ‚Ñƒ:**
  - `envelopeId` - ID ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð° Ð´Ð»Ñ Ð¿Ñ–Ð´Ð¿Ð¸ÑÐ°Ð½Ð½Ñ
  - `returnUrl` - URL Ð´Ð»Ñ Ð¿Ð¾Ð²ÐµÑ€Ð½ÐµÐ½Ð½Ñ Ð¿Ñ–ÑÐ»Ñ Ð¿Ñ–Ð´Ð¿Ð¸ÑÐ°Ð½Ð½Ñ
  - `signerEmail` - Email Ð¿Ñ–Ð´Ð¿Ð¸ÑÐ°Ð½Ñ‚Ð°
  - `signerName` - Ð†Ð¼'Ñ Ð¿Ñ–Ð´Ð¿Ð¸ÑÐ°Ð½Ñ‚Ð°
  - `signerClientId` - (Ð¾Ð¿Ñ†Ñ–Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) ID ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð°
  
ðŸ”¹ **Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ:** 
```json
{
  "success": true,
  "signingUrl": "https://demo.docusign.net/Signing/..."
}
```

---

## 4. Visual Flow (Mermaid Sequence Diagram)

```mermaid
sequenceDiagram
    participant User as End-User (Investor / Company / Private / Agency / Agent)
    participant SetupMyCar as SetupMyCar Interface
    participant Supabase as Supabase DB
    participant DocuSign as DocuSign eSign
    participant Admin as MrVan Admin
    participant ATOM as ATOM Mobility
    
    Note over User: Select Role:\nInvestor / Company / Private / Agency / Agent
    
    User->>SetupMyCar: Provide user type + basic data
    SetupMyCar->>User: Show relevant form fields
    
    alt Investor
        Note over User,SetupMyCar: Provide investment details\nUpload proof of funds\nSign Investor Agreement
    else Company
        Note over User,SetupMyCar: Provide company data\nChoose delegation model\nUpload docs
    else Private
        Note over User,SetupMyCar: Full Delegation only\nUpload personal docs
    else Agency
        Note over User,SetupMyCar: Collaboration scope\nSign Collaboration Agreement
    else Agent
        Note over User,SetupMyCar: Agent profile\nSign Agent Agreement
    end
    
    SetupMyCar->>Supabase: Save user records & documents
    SetupMyCar->>User: Prompt OTP for phone verification
    User->>SetupMyCar: Enter OTP code
    SetupMyCar->>Supabase: Mark phone verified or fail
    Supabase-->>SetupMyCar: success/fail
    
    alt If phone verified
        SetupMyCar->>DocuSign: Create envelope (POST /api/docusign/create-envelope)
        DocuSign-->>SetupMyCar: Return envelopeId
        SetupMyCar->>DocuSign: Get signing URL (POST /api/docusign/embedded-signing)
        DocuSign-->>SetupMyCar: Return signing URL
        SetupMyCar->>User: Show embedded signing interface
        User->>DocuSign: Sign digitally
        DocuSign-->>SetupMyCar: Callback "signed"
        SetupMyCar->>Supabase: Update signature status
        
        SetupMyCar->>Admin: Admin is notified
        Admin->>Supabase: Review documents & data
        alt Approved
            Admin->>Supabase: Set status=approved
            note over SetupMyCar,Admin: If Full Delegation:\nIntegrate w/ ATOM
            Admin->>ATOM: Create vehicle or user entry
            ATOM-->>Admin: Return entity_id
            Admin->>Supabase: Save atom_vehicle_id
        else Rejected
            Admin->>Supabase: Set status=rejected
            SetupMyCar->>User: Request more data or stop process
        end
    else If phone verification fails
        SetupMyCar->>User: Show error / resend code
    end
    
    Note over User,Admin: Done - user or entity onboarded (or rejected)
```