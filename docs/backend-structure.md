# Backend Structure

Цей документ описує фундаментальні частини серверної логіки **prevenc.io**, а також те, як різні компоненти (автентифікація, база даних, сховища, безпека) взаємодіють між собою. Розуміння цієї структури дозволить AI-моделям та команді розробників легко генерувати, інтегрувати та рефакторити код.

---

## 1. Technology Overview

- **Language**: Python 3.9+  
- **Framework**: Flask (мінімалістичний та гнучкий для REST API)  
- **Libraries**:  
  - **PyPDF2**: Парсинг текстових PDF  
  - **Tesseract** (локальний OCR) або **Google Cloud Vision API** (хмарний OCR)  
  - **requests / httpx**: Для зовнішніх HTTP-запитів (до Cloud Vision тощо)  
  - **gunicorn** (виробничий сервер) – за потреби

> **Принцип розгортання**: Запуск через Docker або напряму, із залежностями з `requirements.txt`.

---

## 2. User Authentication

1. **Firebase Authentication (Google Sign-In)**  
   - Користувач отримує ID-токен на фронтенді.  
   - Бекенд верифікує цей токен (через Firebase Admin SDK або Google Identity Platform) перед наданням доступу до ресурсів.

2. **Сесії**  
   - За бажанням можна обмежитися валідацією Firebase-токенів без класичних Flask-сесій.  
   - У кожному запиті фронтенд додає заголовок (наприклад, `Authorization: Bearer <token>`).

3. **Access Control**  
   - Розмежування прав у залежності від тарифу (Free / Licensed / Subscription).  
   - Наприклад, маршрути для AI-рекомендацій доступні лише авторизованим користувачам з оплатою.

---

## 3. Database Architecture (Supabase)

1. **База даних**
   - PostgreSQL через Supabase
   - Вбудована система автентифікації
   - Row Level Security (RLS) для контролю доступу
   - Realtime підписки для живих оновлень

2. **Основні таблиці**
   - **users**: 
     - Профілі користувачів (auth.users від Supabase)
     - Додаткова інформація (тариф, налаштування)
   
   - **uploaded_files**:
     - Метадані завантажень (timestamp, status)
     - Посилання на результати аналізу
     - Статус обробки (pending/processing/completed)

   - **analysis_results**:
     - Результати аналізу PDF
     - Зв'язок з uploaded_files та users
     - Структуровані дані біомаркерів

   - **biomarkers**:
     - Довідник біомаркерів
     - Нормальні діапазони
     - Одиниці виміру

   - **unidentified_biomarkers**:
     - Невпізнані значення для подальшого аналізу
     - Сирий текст для навчання AI

3. **Особливості зберігання**
   - PDF файли тимчасово зберігаються в Supabase Storage
   - Після обробки файли видаляються (GDPR-compliance)
   - Зберігаються лише структуровані результати аналізу

4. **Безпека даних**
   - RLS політики для кожної таблиці
   - Шифрування чутливих даних
   - Аудит доступу через Supabase

---

## 4. Storage Buckets

1. **Google Cloud Storage**  
   - Використовується для короткострокового зберігання, якщо PDF все ж треба проаналізувати.  
   - Після обробки (OCR/парсинг) **видаляємо** або анонімізуємо файли, щоб не тримати приватні дані.  

2. **Локальне зберігання (dev-mode)**  
   - Під час розробки можна тимчасово зберігати файли в локальній папці (наприклад, `tmp/`).  
   - Нагадування: на продакшні уникаємо локального зберігання (через масштабування та безпеку).

---

## 5. API Endpoints

**Приклад структури маршрутизації (Flask):**

| HTTP Method | Endpoint                 | Description                                  | Auth Required |
|-------------|--------------------------|----------------------------------------------|--------------|
| **POST**    | `/api/v1/upload`        | Завантаження PDF, початок парсингу/OCR       | Необов'язково (unauth) – але для перегляду результатів знадобиться вхід |
| **GET**     | `/api/v1/results/{id}`  | Отримати результати аналізу за ID           | Так          |
| **POST**    | `/api/v1/analysis`      | Запуск додаткових обчислень / рекомендацій   | Так          |
| **GET**     | `/api/v1/user/profile`  | Отримати профіль користувача                | Так          |
| **POST**    | `/api/v1/user/upgrade`  | Перейти на платний тариф                    | Так          |

> **Versioning**: `/api/v1/` полегшує оновлення API (додаємо `/api/v2/` у майбутньому).

---

## 6. Security Measures

1. **HTTPS**  
   - Усі запити мають проходити по SSL (через Nginx / Cloud Load Balancer / Google-managed SSL).

2. **Token Validation**  
   - Кожен запит перевіряє валідність Firebase ID-токена. Якщо токен протермінований або неправильний – 401 Unauthorized.

3. **GDPR Compliance**  
   - Зберігаємо мінімум PII (personally identifiable information).  
   - Не зберігаємо оригінальні PDF (вилучаємо після обробки).  
   - Маємо політику анонімізації / видалення файлів після X часу.

4. **Rate Limiting** (за потреби)  
   - Впровадження лімітів на кількість запитів / OCR-операцій на користувача в безкоштовному режимі.

5. **Logging & Monitoring**  
   - Cloud Logging, Sentry, чи інші сервіси для відстеження помилок і швидкого реагування.

---

## 7. Hosting Solutions

1. **Google Cloud Run / App Engine**  
   - Легке масштабування контейнерів Flask.  
   - Тісна інтеграція з іншим GCP-сервісами (Cloud Vision, Cloud Storage, Firebase).

2. **Kubernetes (GKE)**  
   - Для масштабніших систем із багатьма мікросервісами, потрібна складніша інфраструктура.

3. **VM / Compute Engine**  
   - Якщо потрібно більше контролю над ОС (наприклад, власні бібліотеки, особливі конфігурації).  
   - Використання Docker + Gunicorn + Nginx.

4. **Cloud Functions**  
   - Можливе винесення OCR-процесу у безсерверну функцію (кожне зчитування PDF – виклик Cloud Function).

---

## 8. Summary

1. **Flask** – для REST API, із можливістю розширення під масштабні сервіси.  
2. **Firebase Auth (Google Sign-In)** – забезпечує просту й безпечну автентифікацію.  
3. **Database** – PostgreSQL через Supabase, але головне **не** зберігати PDF.  
4. **Storage** – Google Cloud Storage для тимчасових файлів, які видаляються після обробки.  
5. **API** – охоплює маршрути для завантаження PDF, отримання результатів, оновлення тарифів, тощо.  
6. **Security** – HTTPS, токенна авторизація, GDPR, логування.  
7. **Hosting** – переважно на GCP (Cloud Run / App Engine / GKE).

Цей документ є базовим орієнтиром для **AI-моделей** та розробників, які будуть розгортати або рефакторити бекенд. Його варто регулярно оновлювати, у міру появи нових можливостей або змін у бізнес-логіці.

**Версія**: 0.1 
**Дата**: 2025-01-17
**Автор**: [humoliber]